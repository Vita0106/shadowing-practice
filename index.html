<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<title>å½±å­è·Ÿè¯»ç»ƒä¹ </title>
<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif;
  max-width: 860px;
  margin: 40px auto;
  line-height: 1.8;
}

.controls {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-bottom: 14px;
}

.btn {
  border: 1px solid #ccc;
  background: white;
  padding: 6px 12px;
  border-radius: 10px;
  font-size: 18px;
  cursor: pointer;
}

.btn.active {
  background: #dbeafe;
  border-color: #60a5fa;
}

.sentence {
  padding: 10px;
  border-radius: 8px;
  cursor: pointer;
  margin-bottom: 8px;
}

.sentence:hover {
  background: #f3f4f6;
}

.sentence.active {
  background: #dbeafe;
}

.pinyin, .trans {
  font-size: 14px;
  display: none;
}

.pinyin { color: #666; }
.trans { color: #999; }

#recordStatus {
  color: red;
  font-weight: bold;
}

.recordings {
  margin-top: 20px;
}

.recordings h3 {
  margin-bottom: 6px;
}
</style>
</head>
<body>

<h2>å½±å­è·Ÿè¯»ç»ƒä¹ </h2>

<div class="controls">
  <button class="btn" id="playBtn">â–¶ï¸</button>
  <button class="btn" id="pauseBtn">â¸</button>
  <button class="btn" id="loopBtn">ğŸ”</button>
  <button class="btn" id="recordBtn">ğŸ™</button>
  <button class="btn" id="togglePinyin">æ‹¼éŸ³</button>
  <button class="btn" id="toggleTrans">ç¿»è¯‘</button>
  <span id="recordStatus"></span>
</div>

<hr />

<div id="content"></div>

<div class="recordings">
  <h3>ğŸ§ æˆ‘çš„å½•éŸ³</h3>
  <div id="recordList"></div>
</div>

<audio id="audio" src="audio.mp3"></audio>

<script>
/* ========= å†…å®¹åŒºï¼ˆä½ åªæ”¹è¿™é‡Œï¼‰ ========= */

const sentences = [
  { zh: "ä»Šå¤©å¤©æ°”å¾ˆå¥½ã€‚", pinyin: "JÄ«ntiÄn tiÄnqÃ¬ hÄ›n hÇo.", trans: "Today the weather is very nice." },
  { zh: "æˆ‘ä»¬ä¸€èµ·å»å–å’–å•¡å§ã€‚", pinyin: "WÇ’men yÃ¬qÇ qÃ¹ hÄ“ kÄfÄ“i ba.", trans: "Let's go have coffee together." },
  { zh: "ä½ è§‰å¾—æ€ä¹ˆæ ·ï¼Ÿ", pinyin: "NÇ juÃ©de zÄ›nmeyÃ ng?", trans: "What do you think?" }
];

/* ========= åŸºç¡€ ========= */

const audio = document.getElementById("audio");
const content = document.getElementById("content");
const recordList = document.getElementById("recordList");

let timings = [];
let currentIndex = null;
let loopOn = false;
let stopTimer = null;

/* ========= æ¸²æŸ“å¥å­ ========= */

sentences.forEach((s, i) => {
  const div = document.createElement("div");
  div.className = "sentence";
  div.dataset.index = i;
  div.innerHTML = `
    <div>${s.zh}</div>
    <div class="pinyin">${s.pinyin}</div>
    <div class="trans">${s.trans}</div>
  `;
  content.appendChild(div);
});

/* ========= è‡ªåŠ¨åˆ‡å¥ ========= */

audio.addEventListener("loadedmetadata", () => {
  const avg = audio.duration / sentences.length;
  timings = sentences.map((_, i) => ({
    start: i * avg,
    end: (i + 1) * avg
  }));
});

/* ========= æ’­æ”¾å¥å­ ========= */

function playSentence(i) {
  currentIndex = i;
  const { start, end } = timings[i];

  document.querySelectorAll(".sentence").forEach(s => s.classList.remove("active"));
  document.querySelector(`.sentence[data-index="${i}"]`).classList.add("active");

  audio.currentTime = start;
  audio.play();
  playBtn.classList.add("active");

  clearTimeout(stopTimer);
  stopTimer = setTimeout(() => {
    if (loopOn) playSentence(i);
    else audio.pause();
  }, (end - start) * 1000);
}

document.querySelectorAll(".sentence").forEach(el => {
  el.onclick = () => playSentence(Number(el.dataset.index));
});

/* ========= æ§åˆ¶æŒ‰é’® ========= */

playBtn.onclick = () => {
  if (currentIndex !== null) playSentence(currentIndex);
  else audio.play();
};

pauseBtn.onclick = () => {
  audio.pause();
  playBtn.classList.remove("active");
};

loopBtn.onclick = () => {
  loopOn = !loopOn;
  loopBtn.classList.toggle("active", loopOn);
};

togglePinyin.onclick = () => {
  document.querySelectorAll(".pinyin").forEach(p =>
    p.style.display = p.style.display === "block" ? "none" : "block"
  );
};

toggleTrans.onclick = () => {
  document.querySelectorAll(".trans").forEach(t =>
    t.style.display = t.style.display === "block" ? "none" : "block"
  );
};

/* ========= ğŸ™ å½•éŸ³ï¼ˆå¯å›å¬ï¼‰ ========= */

let recorder;
let recording = false;

recordBtn.onclick = async () => {
  if (!recording) {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    recorder = new MediaRecorder(stream);
    recorder.start();

    recording = true;
    recordBtn.classList.add("active");
    recordStatus.innerText = "â— å½•éŸ³ä¸­";

    recorder.ondataavailable = e => {
      const blob = new Blob([e.data], { type: "audio/webm" });
      const url = URL.createObjectURL(blob);

      const audioEl = document.createElement("audio");
      audioEl.controls = true;
      audioEl.src = url;
      recordList.prepend(audioEl);
    };
  } else {
    recorder.stop();
    recording = false;
    recordBtn.classList.remove("active");
    recordStatus.innerText = "";
  }
};
</script>

</body>
</html>
