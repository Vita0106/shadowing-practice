<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>影子跟读练习</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      max-width: 800px;
      margin: 40px auto;
      line-height: 1.8;
    }
    button {
      margin: 8px 0;
      padding: 8px 16px;
      font-size: 16px;
    }
    .sentence {
      cursor: pointer;
      padding: 6px;
      border-radius: 6px;
    }
    .sentence:hover {
      background: #f0f0f0;
    }
    .active {
      background: #dbeafe;
    }
  </style>
</head>
<body>

<h2>影子跟读练习</h2>

<button id="playAll">▶️ 全文播放</button>
<button id="pause">⏸ 暂停</button>

<hr />

<div id="text"></div>

<audio id="audio" src="audio.mp3"></audio>

<script>
/* ========= 1️⃣ 教师只需要改这里 ========= */

const rawText = `
今天天气很好。
我们一起去喝咖啡吧。
你觉得怎么样？
`;

/* ========= 2️⃣ 自动切句 ========= */

const sentences = rawText
  .split(/(?<=[。！？])/)
  .map(s => s.trim())
  .filter(Boolean);

/* ========= 3️⃣ 渲染文本 ========= */

const textEl = document.getElementById("text");

sentences.forEach((s, i) => {
  const span = document.createElement("div");
  span.className = "sentence";
  span.innerText = s;
  span.dataset.index = i;
  textEl.appendChild(span);
});

/* ========= 4️⃣ 音频 + 时间映射（MVP 版） ========= */

/**
 * ⚠️ 这是 MVP 的“平均分配时间”
 * 后期可以换成 AI 对齐
 */
const audio = document.getElementById("audio");
let sentenceTimings = [];

audio.addEventListener("loadedmetadata", () => {
  const duration = audio.duration;
  const avg = duration / sentences.length;

  sentenceTimings = sentences.map((_, i) => ({
    start: i * avg,
    end: (i + 1) * avg
  }));
});

/* ========= 5️⃣ 点击句子播放 ========= */

let stopTimer = null;

function clearActive() {
  document
    .querySelectorAll(".sentence")
    .forEach(el => el.classList.remove("active"));
}

document.querySelectorAll(".sentence").forEach(el => {
  el.addEventListener("click", () => {
    const i = Number(el.dataset.index);
    const { start, end } = sentenceTimings[i];

    clearActive();
    el.classList.add("active");

    audio.currentTime = start;
    audio.play();

    if (stopTimer) clearTimeout(stopTimer);
    stopTimer = setTimeout(() => {
      audio.pause();
    }, (end - start) * 1000);
  });
});

/* ========= 6️⃣ 全文播放 ========= */

document.getElementById("playAll").onclick = () => {
  clearActive();
  audio.currentTime = 0;
  audio.play();
};

document.getElementById("pause").onclick = () => {
  audio.pause();
};
</script>

</body>
</html>
